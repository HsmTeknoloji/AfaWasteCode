package main

import (
	"context"
	"database/sql"
	"fmt"
	"net/http"
	"os"
	"strconv"

	"github.com/go-redis/redis/v8"
	_ "github.com/lib/pq"
)

var debug bool = os.Getenv("DEBUG") == "1"
var port int = 5432
var user string = os.Getenv("POSTGRES_USER")
var password string = os.Getenv("POSTGRES_PASSWORD")
var dbname string = os.Getenv("POSTGRES_DB")
var appStatus string = "1"
var redisDb *redis.Client

var ctx = context.Background()
var sumDb *sql.DB
var bulkDb *sql.DB
var readerDb *sql.DB
var err error

func initStart() {

	logStr("Successfully connected!")
	redisDb = redis.NewClient(&redis.Options{
		Addr:     "waste-redis-cluster-ip:6379",
		Password: "",
		DB:       0,
	})

	pong, err := redisDb.Ping(ctx).Result()
	logErr(err)
	logStr(pong)

}

func main() {

	initStart()

	var sumDbHost string = "waste-sumdb-cluster-ip"
	sumdDbInfo := fmt.Sprintf("host=%s port=%d user=%s "+
		"password=%s dbname=%s sslmode=disable",
		sumDbHost, port, user, password, dbname)

	sumDb, err = sql.Open("postgres", sumdDbInfo)
	logErr(err)
	defer sumDb.Close()

	err = sumDb.Ping()
	logErr(err)

	var bulkDbHost string = "waste-bulkdb-cluster-ip"
	bulkDbInfo := fmt.Sprintf("host=%s port=%d user=%s "+
		"password=%s dbname=%s sslmode=disable",
		bulkDbHost, port, user, password, dbname)

	bulkDb, err = sql.Open("postgres", bulkDbInfo)
	logErr(err)
	defer bulkDb.Close()

	err = bulkDb.Ping()
	logErr(err)

	var readerDbHost string = "waste-readerdb-cluster-ip"
	readerDbInfo := fmt.Sprintf("host=%s port=%d user=%s "+
		"password=%s dbname=%s sslmode=disable",
		readerDbHost, port, user, password, dbname)

	readerDb, err = sql.Open("postgres", readerDbInfo)
	logErr(err)
	defer readerDb.Close()

	err = readerDb.Ping()
	logErr(err)

	logStr("Start")
	http.HandleFunc("/health", healthHandler)
	http.HandleFunc("/readiness", readinessHandler)
	http.HandleFunc("/status", status)
	http.HandleFunc("/getkey", getkey)
	http.HandleFunc("/setkey", setkey)
	http.HandleFunc("/saveBulkDbMain", saveBulkDbMain)
	http.HandleFunc("/saveReaderDbMain", saveReaderDbMain)
	http.ListenAndServe(":80", nil)
	logStr("Finished")
}

func healthHandler(w http.ResponseWriter, r *http.Request) {
	w.WriteHeader(http.StatusOK)
}

func readinessHandler(w http.ResponseWriter, r *http.Request) {
	w.WriteHeader(http.StatusOK)
}

func status(w http.ResponseWriter, req *http.Request) {

	if err := req.ParseForm(); err != nil {
		logErr(err)
		return
	}
	opType := req.FormValue("OPTYPE")
	logStr(opType)

	if opType == "TYPE" {
		w.Write([]byte("WasteStoreApi"))
	} else if opType == "APP" {
		if appStatus == "1" {
			w.Write([]byte("OK"))
		} else {
			w.Write([]byte("FAIL"))
		}
	} else {
		w.Write([]byte("FAIL"))
	}
}

func saveBulkDbMain(w http.ResponseWriter, req *http.Request) {

	if err := req.ParseForm(); err != nil {
		logErr(err)
		return
	}
	appTypeVal := req.FormValue("APPTYPE")
	didVal := req.FormValue("DID")
	dataTypeVal := req.FormValue("DATATYPE")
	timeVal := req.FormValue("TIME")
	dataVal := req.FormValue("DATA")
	customerIdVal, _ := strconv.Atoi(req.FormValue("CUSTOMERID"))
	logStr("Insert BulkDb : " + appTypeVal + " - " + didVal + " - " + dataTypeVal + " - " + timeVal + " - " + dataVal + "-" + string(customerIdVal))
	var insertSQL string = fmt.Sprintf(`INSERT INTO public.listenerdata(
		app_type,serial_number,data_type,data,customer_id,data_time)
	   VALUES ('%s','%s','%s','%s',%d,'%s');`, appTypeVal, didVal, dataTypeVal, dataVal, customerIdVal, timeVal)
	logStr(insertSQL)
	_, errDb := bulkDb.Exec(insertSQL)
	logErr(errDb)
	if errDb != nil {
		logErr(err)
		w.Write([]byte("FAIL"))
	} else {
		w.Write([]byte("OK"))
	}

}

func saveReaderDbMain(w http.ResponseWriter, req *http.Request) {

	var retVal string = "FAIL"
	if err := req.ParseForm(); err != nil {
		logErr(err)
		return
	}
	appTypeVal := req.FormValue("APPTYPE")
	didVal := req.FormValue("DID")
	dataTypeVal := req.FormValue("DATATYPE")
	tableTypeVal := req.FormValue("TABLE")
	dataTime := req.FormValue("TIME")
	repeat := req.FormValue("REPEAT")
	customerIdVal := req.FormValue("CUSTOMERID")

	if appTypeVal == "RFID" {

		var insertSQL string = ""
		if tableTypeVal == "rfdata" {

			tagId := req.FormValue("TAGID")
			uId := req.FormValue("UID")
			logStr(repeat + " - " + dataTypeVal + " - " + tagId + " - " + uId)

			insertSQL = fmt.Sprintf(`INSERT INTO public.rfdata(
				app_type,serial_number,data_type,customer_id,data_time,tagid,uid)
			   VALUES ('%s','%s','%s','%s','%s','%s','%s');`, appTypeVal, didVal, dataTypeVal, customerIdVal, dataTime, tagId, uId)
			logStr(insertSQL)

		} else if tableTypeVal == "gpsdata" {

			latitude := req.FormValue("LATITUDE")
			longitude := req.FormValue("LONGITUDE")
			logStr(repeat + " - " + dataTypeVal + " - " + latitude + " - " + longitude)

			var fLatitude float64 = 0
			var fLongitude float64 = 0
			if latitude != "" {
				if s, err := strconv.ParseFloat(latitude, 32); err == nil {
					fLatitude = s
				}
			}
			if longitude != "" {
				if s, err := strconv.ParseFloat(longitude, 32); err == nil {
					fLongitude = s
				}
			}

			insertSQL = fmt.Sprintf(`INSERT INTO public.gpsdata(
				app_type,serial_number,data_type,customer_id,data_time,latitude,longitude)
			   VALUES ('%s','%s','%s','%s','%s',%f,%f);`, appTypeVal, didVal, dataTypeVal, customerIdVal, dataTime, fLatitude, fLongitude)
			logStr(insertSQL)

		} else if tableTypeVal == "statusdata" {

			readerAppStatus := req.FormValue("READERAPPSTATUS")
			readerConnStatus := req.FormValue("READERCONNSTATUS")
			readerStatus := req.FormValue("READERSTATUS")
			camAppStatus := req.FormValue("CAMAPPSTATUS")
			camConnStatus := req.FormValue("CAMCONNSTATUS")
			camStatus := req.FormValue("CAMSTATUS")
			gpsAppStatus := req.FormValue("GPSAPPSTATUS")
			gpsConnStatus := req.FormValue("GPSCONNSTATUS")
			gpsStatus := req.FormValue("GPSSTATUS")
			thermAppStatus := req.FormValue("THERMAPSTATUS")
			transferAppStatus := req.FormValue("TRANSFERAPP")
			aliveStatus := req.FormValue("ALIVESTATUS")
			contactStatus := req.FormValue("CONTACTSTATUS")
			logStr(repeat + " - " + dataTypeVal + " - " + readerAppStatus + " - " + readerConnStatus + " - " + readerStatus + " - " + camAppStatus + " - " + camConnStatus + " - " + camStatus + " - " + gpsAppStatus + " - " + gpsConnStatus + " - " + gpsStatus + " - " + thermAppStatus + " - " + transferAppStatus + " - " + aliveStatus + " - " + contactStatus)

			insertSQL = fmt.Sprintf(`INSERT INTO public.statusdata(
				app_type,serial_number,data_type,customer_id,data_time,
				reader_app_status,reader_conn_status,reader_status,cam_app_status,cam_conn_status,
				cam_status,gps_app_status,gps_conn_status,gps_status,therm_app_status,transfer_app_status,alive_status,contact_status)
			   VALUES ('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s');
			   `, appTypeVal, didVal, dataTypeVal, customerIdVal, dataTime, readerAppStatus, readerConnStatus, readerStatus, camAppStatus, camConnStatus, camStatus, gpsAppStatus, gpsConnStatus, gpsStatus, thermAppStatus, transferAppStatus, aliveStatus, contactStatus)
			logStr(insertSQL)

		} else if tableTypeVal == "thermdata" {

			therm := req.FormValue("THERM")
			logStr(repeat + " - " + dataTypeVal + " - " + therm)

			insertSQL = fmt.Sprintf(`INSERT INTO public.thermdata(
				app_type,serial_number,data_type,customer_id,data_time,therm)
			   VALUES ('%s','%s','%s','%s','%s','%s');`, appTypeVal, didVal, dataTypeVal, customerIdVal, dataTime, therm)
			logStr(insertSQL)

		} else if tableTypeVal == "camdata" {

			uId := req.FormValue("UID")
			tagId := req.FormValue("TAGID")
			logStr(repeat + " - " + dataTypeVal + " - " + tagId + " - " + uId)

			insertSQL = fmt.Sprintf(`INSERT INTO public.camdata(
				app_type,serial_number,data_type,customer_id,data_time,tagid,uid)
			   VALUES ('%s','%s','%s','%s','%s','%s','%s');`, appTypeVal, didVal, dataTypeVal, customerIdVal, dataTime, tagId, uId)
			logStr(insertSQL)

		} else {
			retVal = "FAIL"
		}

		if insertSQL != "" {
			_, errDb := readerDb.Exec(insertSQL)
			logErr(errDb)
			if errDb != nil {
				logErr(err)
			} else {
				retVal = "OK"
			}
		}
		w.Write([]byte(retVal))
	} else if appTypeVal == "ULT" {
		w.Write([]byte(retVal))
	} else if appTypeVal == "RECY" {
		w.Write([]byte(retVal))
	} else {
		w.Write([]byte(retVal))
	}

}

func getkey(w http.ResponseWriter, req *http.Request) {

	var retVal string = "FAIL"
	if err := req.ParseForm(); err != nil {
		logErr(err)
		return
	}
	hKey := req.FormValue("HASHKEY")
	sKey := req.FormValue("SUBKEY")
	logStr("GetKEy : " + hKey + " - " + sKey)
	retVal = getKeyRedis(hKey, sKey)
	logStr("RetValByRedis : " + retVal)
	if retVal == "NOT" {
		retVal = getKeyDb(hKey, sKey)
		if retVal != "NOT" && retVal != "FAIL" {
			setKeyRedis(hKey, sKey, retVal)
		}
	}
	w.Write([]byte(retVal))
}

func setkey(w http.ResponseWriter, req *http.Request) {

	var retVal string = "OK"
	if err := req.ParseForm(); err != nil {
		logErr(err)
		return
	}
	hKey := req.FormValue("HASHKEY")
	sKey := req.FormValue("SUBKEY")
	kVal := req.FormValue("KEYVALUE")

	retVal = getKeyDb(hKey, sKey)

	if retVal == "NOT" {
		insertKeyDb(hKey, sKey, kVal)
	} else {
		updateKeyDb(hKey, sKey, kVal)
	}
	setKeyRedis(hKey, sKey, kVal)

	w.Write([]byte(retVal))
}

func getKeyRedis(hKey string, sKey string) string {
	var retVal string = "FAIL"
	val, err := redisDb.HGet(ctx, hKey, sKey).Result()
	switch {
	case err == redis.Nil:
		logStr("Not Found")
		retVal = "NOT"
	case err != nil:
		logErr(err)
	case val == "":
		logStr("Not Found")
		retVal = "NOT"
	case val != "":
		retVal = val
		logStr(retVal)
	}

	return retVal
}

func setKeyRedis(hKey string, sKey string, kVal string) {
	redisDb.HSet(ctx, hKey, sKey, kVal).Result()
}

func getKeyDb(hKey string, sKey string) string {
	logStr("Serach Db : " + hKey + " - " + sKey)
	var retVal string = "FAIL"

	var selectSQL string = fmt.Sprintf(`SELECT keyvalue 
	FROM public.redisdata WHERE hashkey='%s' AND subkey='%s';`, hKey, sKey)
	rows, errSel := sumDb.Query(selectSQL)
	logErr(errSel)
	var kVal string = "NOT"
	for rows.Next() {
		rows.Scan(&kVal)
	}

	logStr("KeyValue : " + kVal)

	retVal = kVal
	return retVal
}

func insertKeyDb(hKey string, sKey string, kVal string) string {
	logStr("Insert Db : " + hKey + " - " + sKey + " - " + kVal)
	var retVal string = "OK"
	var insertSQL string = fmt.Sprintf(`INSERT INTO public.redisdata(
		hashkey,subkey,keyvalue)
	   VALUES ('%s','%s','%s');`, hKey, sKey, kVal)
	_, errDb := sumDb.Exec(insertSQL)
	logErr(errDb)
	return retVal
}

func updateKeyDb(hKey string, sKey string, kVal string) string {
	logStr("Update Db : " + hKey + " - " + sKey + " - " + kVal)
	var retVal string = "FAIL"
	var updateSQL string = fmt.Sprintf(`UPDATE public.redisdata SET keyvalue='%s' WHERE hashkey='%s' AND subkey='%s';`, kVal, hKey, sKey)
	_, errDb := sumDb.Exec(updateSQL)
	logErr(errDb)
	return retVal
}

func logErr(err error) {
	if err != nil {
		logStr(err.Error())
	}
}

func logStr(value string) {
	if debug {
		fmt.Println(value)
	}
}
